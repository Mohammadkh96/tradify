üîß TRADIFY ‚Äî CORE BACKEND INFRASTRUCTURE SPEC (DETAILED)
1Ô∏è‚É£ Authentication & Users
1.1 User Model (Database)

Table: users

Required fields:

id (UUID, primary key)

email (string, unique, indexed, lowercase)

password_hash (string, bcrypt or argon2)

email_verified (boolean, default: false)

role (enum: user, admin)

status (enum: active, suspended, deleted)

created_at (timestamp)

updated_at (timestamp)

last_login_at (timestamp, nullable)

Constraints:

Email must be unique

Password must never be stored in plaintext

Soft delete only (status = deleted)

1.2 Password Handling

Hashing requirements

Use bcrypt or argon2

Minimum cost factor equivalent to bcrypt 12+

Hashing must occur server-side only

Password rules

Minimum length: 8

Must contain at least:

1 letter

1 number

Password strength validation happens before hashing

1.3 Registration Flow

Endpoint

POST /auth/register


Input

email

password

Process

Validate request schema

Normalize email (lowercase, trim)

Hash password

Create user with:

email_verified = false

role = user

Generate email verification token

Send verification email

Return success response (no token yet)

Response

201 Created

Generic success message (no user enumeration)

1.4 Email Verification

Table: email_verification_tokens

id

user_id

token (random, hashed in DB)

expires_at

used_at

Endpoint

POST /auth/verify-email


Process

Validate token

Check expiration

Mark token as used

Set email_verified = true

Security

Tokens expire (e.g. 24h)

One-time use

Hash token before storing

1.5 Login Flow

Endpoint

POST /auth/login


Checks

User exists

Password matches hash

Email verified

User status = active

On success

Issue JWT (access token)

Update last_login_at

On failure

Generic error message (no hinting)

1.6 JWT-Based Session Handling

Token type

Access token only (initially)

Signed using secret key

JWT payload

sub = user_id

role

iat

exp

Token rules

Expiry: 15‚Äì60 minutes

Stateless validation

No sensitive data in payload

Authorization header

Authorization: Bearer <token>

1.7 Password Reset Flow

Table: password_reset_tokens

id

user_id

token (hashed)

expires_at

used_at

Endpoints

POST /auth/request-password-reset
POST /auth/reset-password


Flow

User submits email

Always return success response

Generate reset token if user exists

Send reset email

Validate token

Hash new password

Invalidate all active sessions

1.8 User Roles

Roles

user ‚Äî default

admin ‚Äî manual assignment only

Enforcement

Role extracted from JWT

Middleware checks permissions

Admin routes protected explicitly

2Ô∏è‚É£ API Security
2.1 Central API Gateway

Purpose

Single entry point for all requests

Apply cross-cutting concerns:

Auth

Validation

Logging

Rate limiting

Responsibilities

Reject unauthenticated requests (except public routes)

Attach user context to request

Normalize error responses

2.2 Request Validation (Schema-Based)

Rules

Every endpoint MUST have a schema

Reject requests that:

Miss required fields

Contain extra unexpected fields

Have invalid types

Validation occurs

Before business logic

Before DB access

Failure response

400 Bad Request

Structured error object

2.3 Rate Limiting

Scope

Per IP (unauthenticated)

Per user ID (authenticated)

Suggested limits

Auth endpoints: stricter

General API: reasonable burst + steady rate

Behavior

Return 429 Too Many Requests

Include retry information

2.4 API Logging

Log ALL requests

Timestamp

Endpoint

HTTP method

User ID (if available)

IP address

Response status

Response time

Error logging

Stack trace (server-side only)

Correlation ID

Sanitized inputs

Never log

Passwords

Tokens

Sensitive payloads

2.5 Environment-Based Configuration

Environments

development

staging (optional)

production

Configuration rules

Secrets stored in environment variables

No secrets in source code

Separate configs per environment

Examples

JWT secret

Database URL

Email provider credentials

Rate limit thresholds

3Ô∏è‚É£ Middleware Stack (ORDER MATTERS)

Request ID generator

Request logger

Rate limiter

Auth middleware

Schema validation

Business logic handler

Error handler (last)

4Ô∏è‚É£ Error Handling Standard

Response format

{
  "error": {
    "code": "AUTH_INVALID_CREDENTIALS",
    "message": "Invalid email or password"
  }
}


Rules

No stack traces in responses

Consistent error codes

HTTP status codes used correctly

5Ô∏è‚É£ Non-Negotiable Constraints (REPEAT TO REPLIT)

No plaintext passwords ever

No JWT stored in database

No logic bypassing validation

No role escalation via API

No environment secret leakage

6Ô∏è‚É£ Acceptance Criteria (Definition of Done)

User can register, verify email, login

JWT protects private endpoints

Password reset works end-to-end

Admin routes are inaccessible to users

All requests are validated and logged

Rate limits trigger correctly